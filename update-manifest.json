{
  "component": "dunebugger-scheduler",
  "version": "RELEASE_VERSION",
  "description": "Update manifest for dunebugger-scheduler container update",
  
  "pre_checks": [
    {
      "action": "exec",
      "command": "docker-compose --version",
      "description": "Verify docker-compose is available",
      "timeout": 5
    },
    {
      "action": "exec",
      "command": "docker ps --filter name=dunebugger-scheduler --format '{{.Names}}'",
      "expected_output": "dunebugger-scheduler",
      "description": "Verify scheduler container exists before update",
      "timeout": 5
    },
    {
      "action": "exec",
      "command": "test -f /opt/dunebugger/docker-compose.yml && echo 'exists'",
      "expected_output": "exists",
      "description": "Verify docker-compose.yml exists",
      "timeout": 5
    }
  ],
  
  "update_steps": [
    {
      "action": "log",
      "message": "Starting dunebugger-scheduler update to version RELEASE_VERSION"
    },
    {
      "action": "exec",
      "command": "cp /opt/dunebugger/docker-compose.yml /opt/dunebugger/docker-compose.yml.backup",
      "description": "Backup docker-compose.yml before modification",
      "timeout": 5
    },
    {
      "action": "exec",
      "command": "docker-compose -f /opt/dunebugger/docker-compose.yml stop scheduler",
      "description": "Stop scheduler container gracefully",
      "timeout": 60
    },
    {
      "action": "exec",
      "command": "sed -i 's|dunebugger-scheduler:[0-9]\\+\\.[0-9]\\+\\.[0-9]\\+\\(-[a-z0-9.]\\+\\)\\?|dunebugger-scheduler:RELEASE_VERSION|g' /opt/dunebugger/docker-compose.yml",
      "description": "Update scheduler image tag in docker-compose.yml",
      "timeout": 5
    },
    {
      "action": "exec",
      "command": "docker-compose -f /opt/dunebugger/docker-compose.yml pull scheduler",
      "description": "Pull new scheduler image",
      "timeout": 300,
      "retry": {
        "max_attempts": 3,
        "delay": 10
      }
    },
    {
      "action": "exec",
      "command": "docker-compose -f /opt/dunebugger/docker-compose.yml up -d scheduler",
      "description": "Start scheduler with new version",
      "timeout": 60
    }
  ],
  
  "post_checks": [
    {
      "action": "exec",
      "command": "sleep 10 && docker ps --filter name=dunebugger-scheduler --filter status=running --format '{{.Names}}'",
      "expected_output": "dunebugger-scheduler",
      "description": "Wait for container startup and verify it's running",
      "timeout": 30,
      "retry": {
        "max_attempts": 6,
        "delay": 5
      }
    },
    {
      "action": "exec",
      "command": "docker exec dunebugger-scheduler python -c \"from app.version import get_version_info; print(get_version_info()['full_version'])\"",
      "expected_output": "RELEASE_VERSION",
      "description": "Verify new container is running correct version",
      "timeout": 10,
      "retry": {
        "max_attempts": 3,
        "delay": 3
      }
    },
    {
      "action": "exec",
      "command": "docker logs --tail 50 dunebugger-scheduler",
      "description": "Check container logs for startup errors",
      "timeout": 10
    },
    {
      "action": "log",
      "message": "Successfully updated dunebugger-scheduler to version RELEASE_VERSION"
    }
  ],
  
  "rollback_steps": [
    {
      "action": "log",
      "message": "Rolling back dunebugger-scheduler to previous version"
    },
    {
      "action": "exec",
      "command": "docker-compose -f /opt/dunebugger/docker-compose.yml stop scheduler",
      "description": "Stop failed scheduler container",
      "timeout": 60
    },
    {
      "action": "exec",
      "command": "cp /opt/dunebugger/docker-compose.yml.backup /opt/dunebugger/docker-compose.yml",
      "description": "Restore docker-compose.yml from backup",
      "timeout": 5
    },
    {
      "action": "exec",
      "command": "docker-compose -f /opt/dunebugger/docker-compose.yml up -d scheduler",
      "description": "Start scheduler with previous version",
      "timeout": 60
    },
    {
      "action": "exec",
      "command": "sleep 10 && docker ps --filter name=dunebugger-scheduler --filter status=running --format '{{.Names}}'",
      "expected_output": "dunebugger-scheduler",
      "description": "Verify rollback successful",
      "timeout": 30,
      "retry": {
        "max_attempts": 3,
        "delay": 5
      }
    },
    {
      "action": "log",
      "message": "Rollback completed. Scheduler running with previous version."
    }
  ]
}
